# 前列腺癌多模态MRI数据预处理方案

本文档详细描述了前列腺癌多模态MRI分割项目中对数据进行预处理的方式和流程。

## 1. 数据格式要求

### 1.1 图像格式
- 支持NIfTI格式（.nii 和 .nii.gz）
- 支持MetaImage格式（.mhd/.raw）

### 1.2 模态类型
项目支持以下5种MRI模态：
1. ADC (Apparent Diffusion Coefficient)
2. DWI (Diffusion Weighted Imaging)
3. T2 fs (T2-weighted fat saturated)
4. T2 not fs (T2-weighted not fat saturated)
5. gaoqing-T2 (High-resolution T2-weighted)

### 1.3 数据组织结构
```
data/
├── BPH-PCA/
│   ├── BPH/
│   │   ├── ADC/
│   │   ├── DWI/
│   │   ├── T2 fs/
│   │   ├── T2 not fs/
│   │   └── gaoqing-T2/
│   └── ROI(BPH+PCA)/
│       └── BPH/
└── PCA/
    ├── ADC/
    ├── DWI/
    ├── T2 fs/
    ├── T2 not fs/
    └── gaoqing-T2/
```

## 2. 多模态数据预处理流程

### 2.1 数据加载
1. **病例扫描**：遍历数据目录，识别所有有效的病例ID
2. **文件验证**：检查每个病例的各个模态文件和对应的标签文件是否存在
3. **完整性检查**：验证文件的可读性和完整性

### 2.2 缺失模态处理策略
当某个病例缺少某些模态时，系统支持三种处理策略：

#### 2.2.1 Zero Fill (零填充) - 默认策略
- 对于缺失的模态，使用全零数组进行填充
- 保证所有病例具有相同的模态数量，便于批量处理

#### 2.2.2 Skip (跳过)
- 跳过包含缺失模态的整个病例
- 适用于对数据完整性要求较高的场景

#### 2.2.3 Duplicate (复制)
- 使用第一个可用模态的数据来填充缺失模态
- 适用于模态间相似性较高的情况

### 2.3 图像预处理步骤

#### 2.3.1 尺寸统一
- 所有模态图像被调整到统一的目标尺寸（默认为128×128×128）
- 使用SimpleITK的线性插值进行重采样

#### 2.3.2 强度归一化
- 将图像强度值归一化到[0,1]范围内
- 使用非零值的1%和99%分位数进行截断，避免异常值影响
- 公式：`(image - p1) / (p99 - p1 + 1e-8)`

#### 2.3.3 数据类型转换
- 转换为float32数据类型以提高计算效率

#### 2.3.4 多模态合并
- 将5个模态的图像沿通道维度合并成形状为(5, D, H, W)的数组

### 2.4 标签预处理
- 加载对应的分割标签文件
- 将标签二值化（大于0的像素设为1，其余为0）
- 确保标签与图像具有相同的空间尺寸

### 2.5 PyTorch张量转换
- 将预处理后的numpy数组转换为PyTorch张量
- 为训练数据添加批次维度

## 3. 训练时预处理 vs 推理时预处理

### 3.1 训练时预处理
- 使用`script/data_loader.py`中的`ProstateDataset`类
- 支持动态数据增强（如适用）
- 批量处理多个病例

### 3.2 推理时预处理
- 使用`script/predict.py`中的预处理函数
- 单病例处理
- 保持与训练时完全一致的预处理流程

## 4. 配置参数

### 4.1 主要配置项
- `target_size`: 目标图像尺寸，默认(128, 128, 128)
- `missing_strategy`: 缺失模态处理策略，可选'zero_fill'、'skip'、'duplicate'
- `batch_size`: 批次大小
- `data_type`: 数据类型('BPH'或'PCA')

### 4.2 命令行参数
可通过命令行指定预处理相关参数：
```bash
# 训练时指定缺失模态处理策略
python run.py train --handle_missing zero_fill

# 预测时指定缺失模态处理策略
python run.py predict --handle_missing duplicate
```

## 5. 实现细节

### 5.1 核心组件
- `script/data_loader.py`: 训练数据加载和预处理
- `script/predict.py`: 推理时数据加载和预处理
- `ProstateDataset`类: 自定义PyTorch数据集类

### 5.2 关键函数
- `_load_nifti_with_sitk()`: 使用SimpleITK加载NIfTI文件
- `_preprocess_image()`: 图像预处理（尺寸调整、强度归一化）
- `__getitem__()`: 获取单个数据样本并应用完整预处理流程
- `load_multimodal_images()`: 推理时加载多模态图像
- `preprocess_image()`: 推理时图像预处理

## 6. 性能优化措施

### 6.1 内存优化
- 使用适当的目标尺寸平衡精度和内存消耗
- 启用GPU加速的张量操作

### 6.2 计算优化
- 利用SimpleITK进行高效的图像处理
- 批量处理提高数据加载效率
- 异常值处理避免数值不稳定

通过以上预处理方案，系统能够有效地处理多模态MRI数据，确保输入到3D U-Net模型的数据具有一致的格式和质量，从而提高模型的训练效果和预测准确性。